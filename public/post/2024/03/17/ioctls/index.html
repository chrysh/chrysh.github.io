<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ioctls | Linux kernel programming blog</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/static/css/custom.css" />
<meta name="google-site-verification" content="m3n6pzMcloBT3cd6VuLuPT6UnxIO7wfNvpd59oC6S14"/>

  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/post/">Posts</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/about/">About</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Ioctls</span></h1>

<h2 class="date">2024/03/17</h2>
</div>

<main>
<p><a href="https://github.com/Rust-for-Linux/"><img class="penguin" src="/static/img/rusty_penguin_9.jpeg" alt="Rusty penguin. Created by DALL·E 3." /></a></p>
<h1 id="ioctls">Ioctls</h1>
<p>In computing, ioctl calls are special function calls that are used for
operations that can not be done with regular file operations like read, write,
etc. Is is a general purpose interface that is used to send control codes to
devices, set paramters, etc.</p>
<p>Ioctl calls are special kinds of system calls. While system calls like open,
read, write, etc can be applied to all files, ioctls perform device specific
configurations.</p>
<p>Ioctls are used, for example, to set the baudrate of a serial driver, set the
interface and network mask for network drivers, or reserve space for a file for
file system drivers.</p>
<p>General ioctl numbers that are part of the UAPI (User API) can be found in the
header file <code>include/uapi/asm-generic/ioctl.h</code>, while for network-related ioctl
numbers you can look into <code>include/uapi/linux/sockios.h</code>, and for file system
related number <code>include/uapi/linux/fs.h</code>.</p>
<p>In order to make those numbers usable for rust, bindgen generates pub const
numbers as bindings from the defines found in the C header files, as seen in
the following listing.</p>
<pre><code>include/uapi/linux/sockios.h:#define SIOCSIFNETMASK	0x891c		/* set network PA mask		*/
rust/uapi/uapi_generated.rs:pub const SIOCSIFNETMASK: u32 = 35100;
rust/bindings/bindings_generated.rs:pub const SIOCSIFNETMASK: u32 = 35100;

</code></pre>
<p>Let us now look at the defines used to generate those ioctl numbers.</p>
<pre><code>#define _IOC(dir,type,nr,size) \
	(((dir)  &lt;&lt; _IOC_DIRSHIFT) | \
	 ((type) &lt;&lt; _IOC_TYPESHIFT) | \
	 ((nr)   &lt;&lt; _IOC_NRSHIFT) | \
	 ((size) &lt;&lt; _IOC_SIZESHIFT))
</code></pre>
<pre><code>#[inline(always)]
const fn _IOC(dir: u32, ty: u32, nr: u32, size: usize) -&gt; u32 {
    build_assert!(dir &lt;= uapi::_IOC_DIRMASK);
    build_assert!(ty &lt;= uapi::_IOC_TYPEMASK);
    build_assert!(nr &lt;= uapi::_IOC_NRMASK);
    build_assert!(size &lt;= (uapi::_IOC_SIZEMASK as usize));

    (dir &lt;&lt; uapi::_IOC_DIRSHIFT)
        | (ty &lt;&lt; uapi::_IOC_TYPESHIFT)
        | (nr &lt;&lt; uapi::_IOC_NRSHIFT)
        | ((size as u32) &lt;&lt; uapi::_IOC_SIZESHIFT)
}
</code></pre>
<pre><code>/*
 * Used to create numbers.
 *
 * NOTE: _IOW means userland is writing and kernel is reading. _IOR
 * means userland is reading and kernel is writing.
 */
#define _IO(type,nr)		_IOC(_IOC_NONE,(type),(nr),0)
#define _IOR(type,nr,size)	_IOC(_IOC_READ,(type),(nr),(_IOC_TYPECHECK(size)))
#define _IOW(type,nr,size)	_IOC(_IOC_WRITE,(type),(nr),(_IOC_TYPECHECK(size)))
#define _IOWR(type,nr,size)	_IOC(_IOC_READ|_IOC_WRITE,(type),(nr),(_IOC_TYPECHECK(size)))
</code></pre>
<pre><code>
</code></pre>
<pre><code>/* used to decode ioctl numbers.. */
#define _IOC_DIR(nr)		(((nr) &gt;&gt; _IOC_DIRSHIFT) &amp; _IOC_DIRMASK)
#define _IOC_TYPE(nr)		(((nr) &gt;&gt; _IOC_TYPESHIFT) &amp; _IOC_TYPEMASK)
#define _IOC_NR(nr)		(((nr) &gt;&gt; _IOC_NRSHIFT) &amp; _IOC_NRMASK)
#define _IOC_SIZE(nr)		(((nr) &gt;&gt; _IOC_SIZESHIFT) &amp; _IOC_SIZEMASK)
</code></pre>
<pre><code>/// Get the ioctl direction from an ioctl number.
pub const fn _IOC_DIR(nr: u32) -&gt; u32 {
    (nr &gt;&gt; uapi::_IOC_DIRSHIFT) &amp; uapi::_IOC_DIRMASK
}

/// Get the ioctl type from an ioctl number.
pub const fn _IOC_TYPE(nr: u32) -&gt; u32 {
    (nr &gt;&gt; uapi::_IOC_TYPESHIFT) &amp; uapi::_IOC_TYPEMASK
}

/// Get the ioctl number from an ioctl number.
pub const fn _IOC_NR(nr: u32) -&gt; u32 {
    (nr &gt;&gt; uapi::_IOC_NRSHIFT) &amp; uapi::_IOC_NRMASK
}

/// Get the ioctl size from an ioctl number.
pub const fn _IOC_SIZE(nr: u32) -&gt; usize {
    ((nr &gt;&gt; uapi::_IOC_SIZESHIFT) &amp; uapi::_IOC_SIZEMASK) as usize
}
</code></pre>

</main>

  <footer>
  
  
  <hr/>
  © <a href="https://chrysh.github.io">Christina Quast</a> 2024 &ndash; 2024 | <a href="https://github.com/chrysh">Github</a>
  
  </footer>
  </body>
</html>

